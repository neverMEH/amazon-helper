# Session Fixes Summary - August 8, 2025

## Overview
This document summarizes all the fixes and improvements made to resolve workflow execution errors, authentication issues, and token management problems in the Amazon Helper application.

## Issues Resolved

### 1. Workflow ID Truncation Error
**Problem:** 
- Workflow executions were failing with error: `"Workflow with ID wf_e27c2385_b1ed_4bcf_a does not exist"`
- The workflow ID was being truncated to 20 characters when creating AMC workflows

**Root Cause:**
- The AMC execution service was incorrectly truncating workflow IDs using `workflow_id[:20]`
- This caused the AMC API to receive invalid, partial workflow IDs

**Fix Applied:**
- Modified `/root/amazon-helper/amc_manager/services/amc_execution_service.py`
- Now properly uses the `workflow_id` field from the database (format: `wf_XXXXXXXX`)
- Falls back to generating from workflow name if `workflow_id` not present
- Added detection and logging for truncated UUID issues

**Code Changes:**
```python
# Before (line 104)
amc_workflow_id = f"wf_{re.sub(r'[^a-zA-Z0-9]', '_', workflow_id[:20])}"

# After
if workflow.get('workflow_id'):
    amc_workflow_id = workflow['workflow_id']
    logger.info(f"Using existing workflow_id from database: {amc_workflow_id}")
else:
    workflow_name = workflow.get('name', workflow_id)
    clean_name = re.sub(r'[^a-zA-Z0-9]', '_', workflow_name[:30])
    amc_workflow_id = f"wf_{clean_name}"
```

### 2. 403 Authorization Errors When Viewing Executions
**Problem:**
- Users getting `"Failed to list executions: Status 403, Response: {'code': '403', 'details': 'Unauthorized request.'}"` when viewing executions

**Root Cause:**
- Token encryption key mismatch - the `FERNET_KEY` used to encrypt stored OAuth tokens was different from the current key
- All stored tokens were undecryptable, resulting in null tokens being sent to the AMC API
- Entity ID was incorrectly using `profile_id` instead of the AMC account's `entity_id`

**Fixes Applied:**

#### Token Service Improvements (`/root/amazon-helper/amc_manager/services/token_service.py`):
- Added automatic token clearing when decryption fails
- Better error logging for encryption key issues
- Graceful fallback prompting for re-authentication

```python
# Added to decrypt failure handling
logger.error("Token encryption key may have changed. Clearing tokens to force re-authentication.")
try:
    await db_service.update_user(user_id, {'auth_tokens': None})
    logger.info(f"Cleared invalid tokens for user {user_id}")
except Exception as clear_error:
    logger.error(f"Failed to clear invalid tokens: {clear_error}")
```

#### API Error Handling (`/root/amazon-helper/amc_manager/api/supabase/amc_executions.py`):
- Clear 401 errors with instructions to re-authenticate
- Auto-clear tokens on 403 responses from AMC
- Improved error messages with specific guidance

```python
if '403' in str(error_msg) or 'Unauthorized' in str(error_msg):
    logger.warning(f"Got 403/Unauthorized for user {current_user['id']}, clearing tokens")
    await db_service.update_user(current_user['id'], {'auth_tokens': None})
    raise HTTPException(
        status_code=401,
        detail="AMC API authorization failed. Your authentication may have expired. Please re-authenticate in your profile settings."
    )
```

### 3. Token Refresh Service Decryption Errors
**Problem:**
- Token refresh service was failing every 10 minutes with decryption errors
- Logs showed: `"Failed to decrypt token"` for multiple users
- Service was repeatedly trying to refresh invalid tokens

**Root Cause:**
- Some users had tokens encrypted with a different Fernet key
- The refresh service kept trying to decrypt these invalid tokens every interval

**Fixes Applied:**

#### Token Refresh Service (`/root/amazon-helper/amc_manager/services/token_refresh_service.py`):
- Automatically removes users from tracking when tokens can't be decrypted
- Prevents repeated refresh attempts for users with invalid tokens
- Cleans up tracking list when users have no tokens

```python
# In refresh_user_token method
if not valid_token:
    logger.error(f"Failed to refresh token for user {user_id} - removing from tracking")
    self.remove_user(user_id)
    return False

# In exception handler
if "decrypt" in str(e).lower() or "invalid token" in str(e).lower():
    logger.info(f"Removing user {user_id} from tracking due to token issues")
    self.remove_user(user_id)
```

#### Startup Optimization (`/root/amazon-helper/main_supabase.py`):
- Only tracks users who actually have auth tokens
- Provides clear logging of users with/without tokens

```python
# Only track users with tokens
users_with_tokens = 0
for user in users_response.data:
    if user.get('auth_tokens'):
        token_refresh_service.add_user(user['id'])
        users_with_tokens += 1
logger.info(f"✓ Added {users_with_tokens} users with tokens to refresh tracking")
```

### 4. Local Variable Access Error
**Problem:**
- Error: `"cannot access local variable 'db_service' where it is not associated with a value"`

**Root Cause:**
- Duplicate import of `db_service` inside a try block was shadowing the module-level import

**Fix Applied:**
- Removed duplicate import from `/root/amazon-helper/amc_manager/api/supabase/amc_executions.py`
- Used the existing module-level import

## Key Concepts Clarified

### Workflow and Execution IDs
Different IDs serve different purposes in the system:

1. **`workflow_id`** (Internal Database)
   - Format: `wf_XXXXXXXX` (e.g., `wf_4c384646`)
   - Generated when creating a workflow in the system
   - Used as the AMC workflow identifier when syncing to AMC

2. **`amc_workflow_id`** (AMC Saved Workflow)
   - The ID of the saved workflow in AMC
   - Usually same as `workflow_id` when synced
   - Used to execute a saved workflow multiple times

3. **`execution_id`** (Internal Execution)
   - Format: `exec_XXXXXXXX` (e.g., `exec_8698d9a2`)
   - Generated for each execution attempt
   - Tracks the execution in the database

4. **`amc_execution_id`** (AMC Execution)
   - Returned by AMC when executing a workflow
   - Different for each run
   - Used to poll for status and retrieve results

## Testing and Validation

### Test Scripts Created
1. **`test_workflow_execution_fix.py`** - Validated workflow ID handling
2. **`test_token_refresh_fix.py`** - Verified token refresh service improvements
3. **`fix_token_encryption.py`** - Utility to clear invalid encrypted tokens

### Test Results
- ✅ Workflow execution with proper IDs successful
- ✅ Truncated ID detection working correctly
- ✅ Token refresh service handles invalid tokens gracefully
- ✅ Users without valid tokens removed from tracking
- ✅ Import errors resolved

## User Impact and Required Actions

### For Users
1. **Re-authentication Required**: All users need to re-authenticate due to token encryption key changes
2. **Steps to Re-authenticate**:
   - Go to Profile page in the application
   - Click "Re-authenticate with Amazon"
   - Complete the OAuth flow
   - New tokens will be encrypted with the current key

### System Improvements
1. **Self-healing**: System now automatically clears invalid tokens
2. **Clear error messages**: Users get specific instructions when authentication fails
3. **Reduced log spam**: No more repeated decryption errors
4. **Graceful degradation**: Service continues for valid users even when some have issues

## Files Modified

### Core Files
- `/root/amazon-helper/amc_manager/services/amc_execution_service.py` - Fixed workflow ID truncation
- `/root/amazon-helper/amc_manager/services/token_service.py` - Added token cleanup on decryption failure
- `/root/amazon-helper/amc_manager/services/token_refresh_service.py` - Handle invalid tokens gracefully
- `/root/amazon-helper/amc_manager/api/supabase/amc_executions.py` - Improved error handling and removed duplicate import
- `/root/amazon-helper/main_supabase.py` - Optimized startup token tracking

### Documentation
- `/root/amazon-helper/docs/AMC_403_ERROR_TROUBLESHOOTING.md` - Comprehensive troubleshooting guide
- `/root/amazon-helper/workflow_id_fix_summary.md` - Details of workflow ID fix
- This summary document

## Commits Made

1. **Workflow ID Fix**: "fix: Fix workflow ID truncation issue in AMC execution service"
2. **403 Error Resolution**: "fix: Resolve 403 authorization errors when viewing AMC executions"
3. **Token Refresh Fix**: "fix: Handle token decryption failures gracefully in refresh service"
4. **Import Error Fix**: "fix: Remove duplicate db_service import causing local variable error"

## Lessons Learned

1. **Encryption Key Management**: Never change the `FERNET_KEY` once tokens are stored
2. **Entity ID Usage**: Always use the entity ID from the AMC instance's account, not profile IDs
3. **Error Handling**: Provide clear, actionable error messages to users
4. **Self-Healing Systems**: Implement automatic cleanup for invalid data
5. **Graceful Degradation**: Services should continue for valid users even when some have issues

## Prevention Measures

1. **Key Rotation Strategy**: If encryption keys must change, implement backward compatibility
2. **Monitoring**: Add alerts for authentication failures
3. **Testing**: Include tests for token encryption/decryption scenarios
4. **Documentation**: Keep clear documentation of ID types and their purposes
5. **Validation**: Add validation for workflow ID formats before API calls

## Status

All issues have been successfully resolved and fixes have been deployed to the main branch. The application is now functioning correctly with improved error handling and user guidance.