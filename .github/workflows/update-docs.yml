name: Update CLAUDE.md Documentation

on:
  # Run weekly on Mondays at 9 AM UTC
  schedule:
    - cron: '0 9 * * 1'
  
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      days:
        description: 'Number of days to look back for changes'
        required: false
        default: '7'
        type: choice
        options:
          - '7'
          - '14'
          - '30'
          - '60'
          - '90'
      auto_commit:
        description: 'Automatically commit and create PR'
        required: false
        default: true
        type: boolean

jobs:
  update-documentation:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for accurate analysis
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # Install any required dependencies
          if [ -f requirements-docs.txt ]; then
            pip install -r requirements-docs.txt
          fi
      
      - name: Run documentation updater
        run: |
          DAYS="${{ github.event.inputs.days || '7' }}"
          echo "Analyzing last $DAYS days of changes..."
          python scripts/update_claude_md.py --days "$DAYS" --verbose
      
      - name: Check for changes
        id: check_changes
        run: |
          if git diff --quiet CLAUDE.md; then
            echo "No changes detected"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "Changes detected in CLAUDE.md"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            
            # Generate summary of changes
            echo "## Documentation Update Summary" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Files Changed" >> $GITHUB_STEP_SUMMARY
            git diff --stat CLAUDE.md >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Preview of Changes" >> $GITHUB_STEP_SUMMARY
            echo '```diff' >> $GITHUB_STEP_SUMMARY
            git diff CLAUDE.md | head -100 >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Create Pull Request
        if: steps.check_changes.outputs.has_changes == 'true' && (github.event.inputs.auto_commit != 'false' || github.event_name == 'schedule')
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            docs: Auto-update CLAUDE.md with recent changes
            
            - Analyzed last ${{ github.event.inputs.days || '7' }} days of repository activity
            - Updated features, fixes, and architectural changes
            - Generated by automated documentation workflow
            
            🤖 Generated automatically
          branch: auto-update-docs-${{ github.run_number }}
          delete-branch: true
          title: 'docs: Auto-update CLAUDE.md documentation'
          body: |
            ## 📚 Automated Documentation Update
            
            This PR automatically updates the `CLAUDE.md` file with recent repository changes.
            
            ### 🔍 Analysis Period
            - Last **${{ github.event.inputs.days || '7' }}** days of changes analyzed
            - Run triggered by: ${{ github.event_name }}
            
            ### 📝 What's Updated
            - New features and enhancements
            - Bug fixes and improvements
            - API endpoint changes
            - Component updates
            - Service modifications
            - Database schema changes
            - Dependency updates
            
            ### ✅ Review Checklist
            - [ ] Review the changes in CLAUDE.md
            - [ ] Verify all listed features are accurate
            - [ ] Check that sensitive information is not exposed
            - [ ] Ensure formatting is correct
            
            ---
            *This PR was automatically generated by the documentation update workflow.*
          labels: |
            documentation
            automated
          assignees: ${{ github.actor }}
      
      - name: Summary
        run: |
          if [ "${{ steps.check_changes.outputs.has_changes }}" == "true" ]; then
            echo "✅ Documentation updated successfully!"
            if [ "${{ github.event.inputs.auto_commit }}" != "false" ] || [ "${{ github.event_name }}" == "schedule" ]; then
              echo "📝 Pull request created for review"
            else
              echo "⚠️ Changes detected but no PR created (auto_commit=false)"
            fi
          else
            echo "✅ Documentation is already up to date!"
          fi